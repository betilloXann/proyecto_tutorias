name: Flutter CI

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositorio
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'

      # 3Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: flutter pub get

      # 4Ô∏è‚É£ Analizar c√≥digo
      - name: Analyze code
        run: flutter analyze

      # 5Ô∏è‚É£ Ejecutar tests
      - name: Run tests
        run: flutter test

      # 6Ô∏è‚É£ Build APK SOLO en main
      - name: Build APK
        if: github.ref == 'refs/heads/main'
        run: flutter build apk --release

      # 7Ô∏è‚É£ Subir APK como artifact SOLO en main
      - name: Upload APK Artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk

      # 8Ô∏è‚É£ Crear Release SOLO en main
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "Build #${{ github.run_number }}"
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9Ô∏è‚É£ Reportar fallos a Issues autom√°ticamente
      - name: ü§ñ Report Failure to Issues
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ACTOR: ${{ github.actor }}
        run: |
          TITLE="üö® CI Failure: Build fall√≥ en rama '$BRANCH'"
          LABEL="ci-failure"
          BODY="### ‚ùå El CI ha fallado
          
          **Rama:** \`$BRANCH\`
          **Commit:** \`$SHA\`
          **Autor del Push:** @$ACTOR
          
          üîç **[Ver Logs del Error]($RUN_URL)**
          
          Por favor revisa el c√≥digo y soluciona los errores reportados por 'flutter analyze' o 'flutter test'."

          # Crear etiqueta si no existe
          if ! gh label list | grep -q "$LABEL"; then
            echo "La etiqueta '$LABEL' no existe. Cre√°ndola..."
            gh label create "$LABEL" --color "d73a4a" --description "Fallo autom√°tico del CI" || echo "Aviso: No se pudo crear la etiqueta."
          fi

          # Buscar issue abierto con este t√≠tulo
          EXISTING_ISSUE=$(gh issue list --search "$TITLE in:title state:open" --limit 1 --json number --jq '.[0].number')

          if [ -z "$EXISTING_ISSUE" ]; then
            echo "Creando nuevo Issue..."
            gh issue create \
              --title "$TITLE" \
              --body "$BODY" \
              --label "$LABEL" \
              --assignee "$ACTOR"
          else
            echo "Actualizando Issue #$EXISTING_ISSUE..."
            gh issue comment $EXISTING_ISSUE \
              --body "‚ö†Ô∏è **Nueva falla detectada** en el commit \`$SHA\`. Revisa los [nuevos logs aqu√≠]($RUN_URL)."
          fi

      # üîü Cerrar issue si todo pasa
      - name: ‚úÖ Close CI Issue if build succeeds
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          TITLE="üö® CI Failure: Build fall√≥ en rama '$BRANCH'"

          # Buscar issue abierto
          EXISTING_ISSUE=$(gh issue list --search "$TITLE in:title state:open" --limit 1 --json number --jq '.[0].number')

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Cerrando Issue #$EXISTING_ISSUE porque el CI pas√≥ ‚úÖ"
            gh issue comment $EXISTING_ISSUE --body "‚úÖ CI pas√≥ correctamente, cerrando este issue autom√°ticamente."
            gh issue close $EXISTING_ISSUE
          else
            echo "No hay issue de fallo de CI abierto para cerrar."
          fi
