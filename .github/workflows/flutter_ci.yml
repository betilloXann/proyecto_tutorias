name: Flutter CI

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop ]

# 1. PERMISOS NECESARIOS (CR√çTICO)
# Damos permiso de escritura en issues para que el bot pueda crear/comentar.
permissions:
  contents: read
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test

      # --- PASO DE REPORTE AUTOM√ÅTICO DE FALLOS ---
      - name: ü§ñ Report Failure to Issues
        if: failure() # Solo se ejecuta si los pasos anteriores fallaron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ACTOR: ${{ github.actor }}
        run: |
          # Variables de configuraci√≥n
          TITLE="üö® CI Failure: Build fall√≥ en rama '$BRANCH'"
          LABEL="ci-failure"
          BODY="### ‚ùå El CI ha fallado
          
          **Rama:** \`$BRANCH\`
          **Commit:** \`$SHA\`
          **Autor del Push:** @$ACTOR
          
          üîç **[Ver Logs del Error]($RUN_URL)**
          
          Por favor revisa el c√≥digo y soluciona los errores reportados por 'flutter analyze' o 'flutter test'."

          # 0. L√ìGICA DE AUTO-CREACI√ìN DE ETIQUETA (OPCI√ìN 2)
          # Verificamos si la etiqueta existe. Si no, la creamos al vuelo.
          if ! gh label list | grep -q "$LABEL"; then
            echo "La etiqueta '$LABEL' no existe. Cre√°ndola..."
            gh label create "$LABEL" --color "d73a4a" --description "Fallo autom√°tico del CI" || echo "Aviso: No se pudo crear la etiqueta (posiblemente falta de permisos o ya existe)."
          else
            echo "La etiqueta '$LABEL' ya existe. Continuando..."
          fi

          # 1. Buscar si ya existe un issue abierto con este t√≠tulo
          EXISTING_ISSUE=$(gh issue list --search "$TITLE in:title state:open" --limit 1 --json number --jq '.[0].number')

          if [ -z "$EXISTING_ISSUE" ]; then
            # CASO A: No existe issue previo, creamos uno nuevo
            echo "Creando nuevo Issue..."
            gh issue create \
              --title "$TITLE" \
              --body "$BODY" \
              --label "$LABEL" \
              --assignee "$ACTOR"
          else
            # CASO B: Ya existe issue abierto, comentamos en √©l
            echo "Actualizando Issue #$EXISTING_ISSUE..."
            gh issue comment $EXISTING_ISSUE \
              --body "‚ö†Ô∏è **Nueva falla detectada** en el commit \`$SHA\`. Revisa los [nuevos logs aqu√≠]($RUN_URL)."
          fi